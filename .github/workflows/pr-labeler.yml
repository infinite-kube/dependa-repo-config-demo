# .github/workflows/pr-labeler.yml
name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-pr:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add update-type labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const updateType = '${{ steps.metadata.outputs.update-type }}';
            const dependencyType = '${{ steps.metadata.outputs.dependency-type }}';
            const alertState = '${{ steps.metadata.outputs.alert-state }}';
            const ghsaId = '${{ steps.metadata.outputs.ghsa-id }}';
            const cvss = parseFloat('${{ steps.metadata.outputs.cvss }}') || 0;
            
            const labels = [];
            
            // Update type labels
            if (updateType === 'version-update:semver-patch') {
              labels.push('patch-update', 'auto-merge-candidate');
            } else if (updateType === 'version-update:semver-minor') {
              labels.push('minor-update', 'auto-merge-candidate');
            } else if (updateType === 'version-update:semver-major') {
              labels.push('major-update', 'requires-review');
            }
            
            // Dependency type labels
            if (dependencyType === 'direct:production') {
              labels.push('production-dependency');
            } else if (dependencyType === 'direct:development') {
              labels.push('dev-dependency', 'auto-merge-candidate');
            } else if (dependencyType === 'indirect') {
              labels.push('transitive-dependency');
            }
            
            // Security labels based on CVSS score
            if (ghsaId || alertState === 'open') {
              labels.push('security');
              
              if (cvss >= 9.0) {
                labels.push('severity-critical', 'requires-review', 'urgent');
                // Remove auto-merge candidate if critical
                const autoMergeIndex = labels.indexOf('auto-merge-candidate');
                if (autoMergeIndex > -1) labels.splice(autoMergeIndex, 1);
              } else if (cvss >= 7.0) {
                labels.push('severity-high', 'requires-review');
                const autoMergeIndex = labels.indexOf('auto-merge-candidate');
                if (autoMergeIndex > -1) labels.splice(autoMergeIndex, 1);
              } else if (cvss >= 4.0) {
                labels.push('severity-medium');
              } else if (cvss > 0) {
                labels.push('severity-low');
              }
            }
            
            // Add labels to PR
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }
            
            console.log(`Added labels: ${labels.join(', ')}`);
