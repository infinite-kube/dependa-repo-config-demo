# .github/workflows/dependabot-auto-merge.yml
name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Run tests but don't block on failure
  test:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    continue-on-error: true  # Tests run but don't block
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"
          pip install pytest pytest-cov 2>/dev/null || echo "pytest not needed"

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            pytest --tb=short || echo "Tests completed with failures"
          else
            echo "No tests found - skipping"
          fi

      - name: Add test result label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testResult = '${{ steps.tests.outcome }}';
            const label = testResult === 'success' ? 'tests-passed' : 'tests-failed';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

  # Evaluate and auto-merge eligible PRs
  auto-merge:
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.actor == 'dependabot[bot]'
    
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate auto-merge eligibility
        id: evaluate
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const updateType = '${{ steps.metadata.outputs.update-type }}';
            const dependencyType = '${{ steps.metadata.outputs.dependency-type }}';
            const cvss = parseFloat('${{ steps.metadata.outputs.cvss }}') || 0;
            const alertState = '${{ steps.metadata.outputs.alert-state }}';
            
            let shouldAutoMerge = false;
            let reason = '';
            
            // BLOCK: Critical or High severity security issues (CVSS >= 7.0)
            if (cvss >= 7.0) {
              reason = `Security issue with CVSS ${cvss} requires manual review`;
              console.log(`❌ ${reason}`);
              core.setOutput('should_merge', 'false');
              core.setOutput('reason', reason);
              return;
            }
            
            // BLOCK: Major version updates
            if (updateType === 'version-update:semver-major') {
              reason = 'Major version update requires manual review';
              console.log(`❌ ${reason}`);
              core.setOutput('should_merge', 'false');
              core.setOutput('reason', reason);
              return;
            }
            
            // AUTO-MERGE: Patch updates
            if (updateType === 'version-update:semver-patch') {
              shouldAutoMerge = true;
              reason = 'Patch update - auto-merging';
            }
            
            // AUTO-MERGE: Minor updates
            if (updateType === 'version-update:semver-minor') {
              shouldAutoMerge = true;
              reason = 'Minor update - auto-merging';
            }
            
            // AUTO-MERGE: Dev dependencies (any update type except major)
            if (dependencyType === 'direct:development' && updateType !== 'version-update:semver-major') {
              shouldAutoMerge = true;
              reason = 'Development dependency - auto-merging';
            }
            
            // AUTO-MERGE: Low/Medium severity security fixes
            if (alertState === 'open' && cvss > 0 && cvss < 7.0) {
              shouldAutoMerge = true;
              reason = `Security fix (CVSS ${cvss}) - auto-merging`;
            }
            
            console.log(shouldAutoMerge ? `✅ ${reason}` : `❌ ${reason}`);
            core.setOutput('should_merge', shouldAutoMerge.toString());
            core.setOutput('reason', reason);

      - name: Enable auto-merge
        if: steps.evaluate.outputs.should_merge == 'true'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add review-required comment
        if: steps.evaluate.outputs.should_merge == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reason = '${{ steps.evaluate.outputs.reason }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `⚠️ **Manual Review Required**\n\nReason: ${reason}\n\nPlease review this PR before merging.`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['requires-review', 'manual-approval-needed']
            });
