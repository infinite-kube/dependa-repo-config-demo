name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: TEST
  # Runs tests to ensure the dependency doesn't break the build.
  # ------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    continue-on-error: true # Allow workflow to proceed to labeling even if tests fail
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Try to install requirements, ignore if missing
          pip install -r requirements.txt 2>/dev/null || echo "No requirements.txt found"
          # Try to install test runners
          pip install pytest pytest-cov 2>/dev/null || echo "pytest installation skipped"

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            pytest --tb=short || echo "Tests completed with failures"
          else
            echo "No tests found - skipping"
          fi

      - name: Label test result
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testResult = '${{ steps.tests.outcome }}';
            // Determine label based on success or failure
            const label = testResult === 'success' ? 'tests-passed' : 'tests-failed';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

  # ------------------------------------------------------------------
  # JOB 2: EVALUATE & AUTO-MERGE
  # Checks metadata to determine if the update is safe (non-critical).
  # ------------------------------------------------------------------
  auto-merge:
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.actor == 'dependabot[bot]'
    
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check safety and decide
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Get Metadata
            const updateType = '${{ steps.metadata.outputs.update-type }}';
            const dependencyType = '${{ steps.metadata.outputs.dependency-type }}';
            const cvss = parseFloat('${{ steps.metadata.outputs.cvss }}') || 0;
            const alertState = '${{ steps.metadata.outputs.alert-state }}';
            
            let shouldMerge = false;
            let reason = '';
            let labelToAdd = '';

            console.log(`Update Type: ${updateType}`);
            console.log(`CVSS Score: ${cvss}`);

            // 2. LOGIC: Define what blocks a merge
            const isMajor = updateType === 'version-update:semver-major';
            const isHighSeverity = cvss >= 7.0;

            if (isMajor) {
              reason = 'Major version update detected (potential breaking changes). Manual review required.';
              labelToAdd = 'requires-manual-review';
            } else if (isHighSeverity) {
               reason = `High severity security issue (CVSS ${cvss}). Manual review required.`;
               labelToAdd = 'critical';
            } else {
              // 3. LOGIC: Define what allows a merge
              // Allow: Patch, Minor, or Development dependencies (that aren't major)
              if (
                updateType === 'version-update:semver-patch' ||
                updateType === 'version-update:semver-minor' ||
                (dependencyType === 'direct:development' && !isMajor)
              ) {
                shouldMerge = true;
                reason = 'Non-critical update (Minor/Patch/Dev). Auto-merging.';
                labelToAdd = 'auto-merge';
              }
            }

            console.log(shouldMerge ? `✅ ${reason}` : `❌ ${reason}`);
            
            // Output results for next steps
            core.setOutput('should_merge', shouldMerge.toString());
            core.setOutput('reason', reason);
            core.setOutput('label_to_add', labelToAdd);

      - name: Label PR
        if: steps.check.outputs.label_to_add != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = '${{ steps.check.outputs.label_to_add }}';
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [label]
            });

      - name: Auto-merge
        if: steps.check.outputs.should_merge == 'true'
        run: |
          echo "Merging PR: ${{ steps.check.outputs.reason }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment if Manual Review Required
        if: steps.check.outputs.should_merge == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reason = '${{ steps.check.outputs.reason }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `⚠️ **Manual Review Required**\n\nAuto-merge blocked.\nReason: ${reason}`
            });
